<!doctype html>
<html>
<head>
  <base target="_top" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="食材検索">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <style>
    :root{
      --bg:#0b0f1a;
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.6);
      --focus:rgba(99,102,241,.9);
      --search-height: 58svh;
    }

    *{box-sizing:border-box;}
    html,body{height:100%;}

    body{
      margin:0;
      font-family:system-ui,-apple-system,"Hiragino Sans","Noto Sans JP",sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 10% 0%, rgba(99,102,241,.35), transparent 55%),
        radial-gradient(900px 700px at 90% 10%, rgba(16,185,129,.28), transparent 60%),
        linear-gradient(180deg,#070a12,var(--bg));
      min-height:100svh;
      display:flex;
      justify-content:center;
      align-items:center;
      padding:env(safe-area-inset-top) 16px env(safe-area-inset-bottom);
    }

    .wrap{
      width:100%;
      max-width:800px;
      display:flex;
      flex-direction:column;
      gap:calc(var(--search-height) * 0.30);
      align-items:flex-start;
    }

    h1{
      margin:0;
      font-size:calc(var(--search-height) * 0.25);
      text-align:left;
      width:100%;
    }

    /* ======================
       検索エリア
    ====================== */
    .searchContainer{
      display:flex;
      flex-direction:column;
      gap:calc(var(--search-height) * 0.15);
      width:100%;
    }

    .searchArea{
      position:relative;
      display:flex;
      flex-direction:column;
      gap:calc(var(--search-height) * 0.10);
    }

    .searchBar{
      height:var(--search-height);
      min-height:70px;
      border-radius:calc(var(--search-height) * 0.2);
      background:rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.15);
      display:flex;
      align-items:center;
      padding:0 calc(var(--search-height) * 0.25);
      transition:.2s;
    }
    .searchBar:focus-within{
      border-color:var(--focus);
      box-shadow:0 0 0 2px rgba(99,102,241,.3);
    }

    .searchInput{
      width:100%;
      height:100%;
      border:none;
      outline:none;
      background:transparent;
      color:var(--text);
      font-size:clamp(16px,4vw,calc(var(--search-height)*0.35));
    }

    .btnRow{
      display:flex;
      gap:calc(var(--search-height) * 0.12);
      width:100%;
      align-items:stretch;
    }

    .searchBtn{
      flex:1;
      height:calc(var(--search-height) * 0.45);
      min-height:44px;
      border:none;
      border-radius:calc(var(--search-height) * 0.15);
      background:linear-gradient(180deg,#6366f1,#4f46e5);
      color:#fff;
      font-weight:600;
      font-size:calc(var(--search-height) * 0.18);
      cursor:pointer;
      transition:.15s;
    }
    .searchBtn:active{ transform:scale(.98); }

    .addBtn{
      flex:1;
      height:calc(var(--search-height) * 0.45);
      min-height:44px;
      border:none;
      border-radius:calc(var(--search-height) * 0.15);
      background:linear-gradient(180deg,#10b981,#059669);
      color:#fff;
      font-weight:700;
      font-size:calc(var(--search-height) * 0.18);
      cursor:pointer;
      transition:.15s;
    }
    .addBtn:active{ transform:scale(.98); }
    .addBtn:disabled{
      opacity:.45;
      cursor:not-allowed;
      transform:none;
    }

    /* ======================
       候補リスト（自前）
    ====================== */
    .suggest{
      position:absolute;
      left:0;
      right:0;
      top:calc(var(--search-height) + (var(--search-height) * 0.10));
      border-radius:calc(var(--search-height) * 0.15);
      border:1px solid rgba(255,255,255,.14);
      background:rgba(10,12,18,.92);
      backdrop-filter: blur(10px);
      box-shadow: 0 18px 50px rgba(0,0,0,.45);
      overflow:hidden;
      display:none;
      z-index:20;
    }
    .suggest.open{ display:block; }

    .suggestList{
      list-style:none;
      margin:0;
      padding:0;
      max-height: var(--search-height);
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }
    .suggestItem{
      padding:calc(var(--search-height) * 0.3) calc(var(--search-height) * 0.25);
      font-size:calc(var(--search-height) * 0.28);
      line-height:1.25;
      color:rgba(255,255,255,.92);
      border-top:1px solid rgba(255,255,255,.08);
      cursor:pointer;
      user-select:none;
    }
    .suggestItem:first-child{ border-top:none; }
    .suggestItem:active{ background:rgba(255,255,255,.08); }

    .suggestEmpty{
      padding:calc(var(--search-height) * 0.14) calc(var(--search-height) * 0.20);
      font-size:calc(var(--search-height) * 0.18);
      color:rgba(255,255,255,.55);
    }

    /* ======================
       検索結果
    ====================== */
    .result{
      margin-top:calc(var(--search-height) * 0.15);
      display:flex;
      flex-direction:column;
      gap:calc(var(--search-height) * 0.20);
      width:100%;
      align-items:flex-start;
    }

    .resultTitle{
      margin:0;
      text-align:left;
      width:100%;
    }

    .dishName{
      font-size:calc(var(--search-height) * 0.32);
      font-weight:600;
    }

    .suffix{
      font-size:calc(var(--search-height) * 0.22);
      font-weight:500;
      opacity:0.8;
      margin-left:0.3em;
    }

    .chips{
      display:flex;
      flex-wrap:wrap;
      gap:calc(var(--search-height) * 0.15);
      list-style:none;
      padding:0;
      margin:0;
      justify-content:flex-start;
      width:100%;
    }

    .chip{
      padding:calc(var(--search-height) * 0.12) calc(var(--search-height) * 0.22);
      border-radius:999px;
      background:rgba(255,255,255,.08);
      font-size:clamp(16px, 4vw, calc(var(--search-height)*0.35));
    }

    /* 必要な食材チップの注釈（由来）を小さく・薄く */
    .chip .meta{
      opacity:.65;
      font-size:0.82em;
      margin-left:0.35em;
      white-space:nowrap;
    }

    .empty{
      text-align:left;
      color:var(--muted);
      font-size:calc(var(--search-height) * 0.20);
      white-space:pre-line;
      width:100%;
    }

    /* ======================
       献立エリア（見た目は「検索結果」と同じ思想に統一）
    ====================== */
    .plan{
      width:100%;
      display:flex;
      flex-direction:column;
      gap:calc(var(--search-height) * 0.18);
      margin-top:calc(var(--search-height) * 0.05);
      padding-top:calc(var(--search-height) * 0.15);
      border-top:1px solid rgba(255,255,255,.12);
      background:transparent; /* ← 念のため固定（背景を持たせない） */
    }

    .planHead{
      display:flex;
      align-items:baseline;
      gap:0.6em;
      width:100%;
    }

    .planTitle{
      margin:0;
      font-size:calc(var(--search-height) * 0.22);
      font-weight:700;
    }

    .planSub{
      margin:0;
      font-size:calc(var(--search-height) * 0.16);
      color:rgba(255,255,255,.6);
    }

    /* 献立（料理）も chips と同じ見せ方に統一 */
    .menuList{
      list-style:none;
      padding:0;
      margin:0;
      display:flex;
      flex-wrap:wrap;
      gap:calc(var(--search-height) * 0.12);
      width:100%;
    }

    /* menuItem を chip と同じ背景に */
    .menuItem{
      display:inline-flex;
      align-items:center;
      gap:0.5em;
      padding:calc(var(--search-height) * 0.10) calc(var(--search-height) * 0.18);
      border-radius:999px;
      background:rgba(255,255,255,.08);
      font-size:calc(var(--search-height) * 0.18);
    }

    .removeBtn{
      border:none;
      background:rgba(255,255,255,.12);
      color:rgba(255,255,255,.9);
      width:1.8em;
      height:1.8em;
      border-radius:999px;
      cursor:pointer;
      font-weight:800;
      line-height:1;
    }
    .removeBtn:active{ transform:scale(.96); }

    /* 必要な食材も chips と完全統一するので、縦リストはやめて chips に寄せる */
    .needList{
      list-style:none;
      padding:0;
      margin:0;
      display:flex;
      flex-wrap:wrap;  /* ← chips 形式 */
      gap:calc(var(--search-height) * 0.15);
      width:100%;
    }

    /* needItem は使わない（互換のため残してもOKだけど、ここでは未使用） */
    .needItem{ display:none; }

    .planEmpty{
      color:rgba(255,255,255,.55);
      font-size:calc(var(--search-height) * 0.18);
      white-space:pre-line;
      margin:0;
    }

    @media (min-width:720px){
      :root{ --search-height:120px; }
      body{ align-items:flex-start; padding:40px 16px; }
      .suggestList{ max-height: 280px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>食材検索アプリ</h1>

    <form class="searchContainer" onsubmit="event.preventDefault(); search();">
      <div class="searchArea">
        <div class="searchBar">
          <input
            id="dish"
            class="searchInput"
            placeholder="料理名を入力（例：親子丼）"
            autocomplete="off"
            enterkeyhint="search"
            inputmode="search"
          />
        </div>

        <!-- 自前の候補リスト -->
        <div class="suggest" id="suggestBox" aria-label="検索候補">
          <ul class="suggestList" id="suggestList"></ul>
        </div>
      </div>

      <!-- ボタン行：検索 + 献立に追加 -->
      <div class="btnRow">
        <button type="submit" class="searchBtn">検索する</button>
        <button type="button" class="addBtn" id="addBtn" disabled>献立に追加</button>
      </div>
    </form>

    <div class="result" aria-live="polite">
      <h2 class="resultTitle" id="resultTitle">食材</h2>
      <ul class="chips" id="chips"></ul>
      <div class="empty" id="emptyText">料理名を入力して検索してください。</div>
    </div>

    <!-- 献立 -->
    <section class="plan" aria-live="polite">
      <div class="planHead">
        <h2 class="planTitle">献立</h2>
        <p class="planSub" id="planSub">（0品）</p>
      </div>

      <ul class="menuList" id="menuList"></ul>
      <p class="planEmpty" id="planEmpty">「献立に追加」を押すと、ここに料理がたまります。下に必要な食材を表示します。</p>

      <h3 class="planTitle" style="margin-top:0.2em;">必要な食材</h3>
      <!-- chips と同じ見た目にするので、needList も chip を入れる -->
      <ul class="needList" id="needList"></ul>
    </section>
  </div>

<script>
  const dishInput = document.getElementById('dish');
  const chipsEl   = document.getElementById('chips');
  const titleEl   = document.getElementById('resultTitle');
  const emptyEl   = document.getElementById('emptyText');

  const suggestBox  = document.getElementById('suggestBox');
  const suggestList = document.getElementById('suggestList');

  const addBtn    = document.getElementById('addBtn');
  const menuList  = document.getElementById('menuList');
  const needList  = document.getElementById('needList');
  const planSub   = document.getElementById('planSub');
  const planEmpty = document.getElementById('planEmpty');

  let dishNames = [];
  let recipesMap = {};
  let lastQuery = "";

  // 献立（追加した料理名）
  const menu = new Set();

  google.script.run.withSuccessHandler(n=>{
    dishNames = (n || []).map(String);
  }).getDishNames();

  google.script.run.withSuccessHandler(m=>{
    recipesMap = m || {};
  }).getAllRecipes();

  // ===== 候補表示（自前） =====
  let t = null;

  dishInput.addEventListener("input", () => {
    clearTimeout(t);
    t = setTimeout(() => renderSuggestions(dishInput.value), 60);
  });

  dishInput.addEventListener("focus", () => {
    renderSuggestions(dishInput.value);
  });

  dishInput.addEventListener("blur", () => {
    setTimeout(() => closeSuggestions(), 120);
  });

  dishInput.addEventListener("keydown", (e) => {
    if (e.isComposing) return;
    if (e.key === "Enter") {
      e.preventDefault();
      closeSuggestions();
      search();
    }
  });

  document.addEventListener("pointerdown", (e) => {
    const inside = e.target === dishInput || suggestBox.contains(e.target);
    if (!inside) closeSuggestions();
  });

  function openSuggestions(){
    if (!suggestBox.classList.contains("open")) suggestBox.classList.add("open");
  }
  function closeSuggestions(){
    suggestBox.classList.remove("open");
    suggestList.innerHTML = "";
  }

  function renderSuggestions(text){
    const q = (text || "").trim().toLowerCase();

    if (!q){
      closeSuggestions();
      return;
    }

    if (!dishNames.length){
      suggestList.innerHTML = `<li class="suggestEmpty">読み込み中...</li>`;
      openSuggestions();
      return;
    }

    const hits = [];
    for (const name of dishNames){
      const s = String(name);
      if (s.toLowerCase().includes(q)){
        hits.push(s);
        if (hits.length >= 10) break;
      }
    }

    if (!hits.length){
      suggestList.innerHTML = `<li class="suggestEmpty">候補がありません</li>`;
      openSuggestions();
      return;
    }

    suggestList.innerHTML = hits.map(x =>
      `<li class="suggestItem" data-name="${escapeHtmlAttr(x)}">${escapeHtml(x)}</li>`
    ).join("");

    openSuggestions();
  }

  suggestList.addEventListener("pointerdown", (e) => {
    const li = e.target.closest(".suggestItem");
    if (!li) return;

    e.preventDefault();
    const name = li.getAttribute("data-name") || "";
    dishInput.value = unescapeHtmlAttr(name);

    closeSuggestions();
    search();
    dishInput.blur();
  });

  // ===== 検索 =====
  function search(){
    const dish = dishInput.value.trim();
    if (!dish){
      lastQuery = "";
      titleEl.textContent = "食材";
      chipsEl.innerHTML = "";
      emptyEl.textContent = "料理名を入力して検索してください。";
      emptyEl.style.display = "block";
      addBtn.disabled = true;
      return;
    }
    if (dish === lastQuery) {
      updateAddButtonState(dish);
      return;
    }
    lastQuery = dish;

    const items = recipesMap[dish] || [];
    chipsEl.innerHTML = items.map(i => `<li class="chip">${escapeHtml(i)}</li>`).join("");

    if (items.length){
      titleEl.innerHTML =
        `<span class="dishName">${escapeHtml(dish)}</span><span class="suffix">の食材</span>`;
      emptyEl.textContent = "";
      emptyEl.style.display = "none";
    } else {
      titleEl.textContent = "食材";
      emptyEl.textContent = "見つかりませんでした。料理名が完全一致しているか確認してください。";
      emptyEl.style.display = "block";
    }

    updateAddButtonState(dish);
  }

  function updateAddButtonState(dish){
    const items = recipesMap[dish] || [];
    addBtn.disabled = !(items.length && !menu.has(dish));
  }

  // ===== 献立に追加 =====
  addBtn.addEventListener("click", () => {
    const dish = dishInput.value.trim();
    if (!dish) return;

    const items = recipesMap[dish] || [];
    if (!items.length) return;

    if (menu.has(dish)) {
      updateAddButtonState(dish);
      return;
    }

    menu.add(dish);
    renderMenu();
    renderNeededIngredients();
    updateAddButtonState(dish);
  });

  // ===== 献立表示（料理リスト） =====
  function renderMenu(){
    const arr = Array.from(menu);

    planSub.textContent = `（${arr.length}品）`;

    if (!arr.length){
      menuList.innerHTML = "";
      planEmpty.style.display = "block";
      return;
    }

    planEmpty.style.display = "none";

    menuList.innerHTML = arr.map(d =>
      `<li class="menuItem">
         <span>${escapeHtml(d)}</span>
         <button class="removeBtn" type="button" aria-label="${escapeHtmlAttr(d)} を削除" data-dish="${escapeHtmlAttr(d)}">×</button>
       </li>`
    ).join("");
  }

  // 削除ボタン（イベント委譲）
  menuList.addEventListener("click", (e) => {
    const btn = e.target.closest(".removeBtn");
    if (!btn) return;
    const dish = unescapeHtmlAttr(btn.getAttribute("data-dish") || "");
    if (!dish) return;

    menu.delete(dish);
    renderMenu();
    renderNeededIngredients();
    updateAddButtonState(dishInput.value.trim());
  });

  // ===== 必要な食材（重複排除＋料理名明示） =====
  // ここを「chip 表示」に完全統一
  function renderNeededIngredients(){
    const dishes = Array.from(menu);
    if (!dishes.length){
      needList.innerHTML = "";
      return;
    }

    // ingredient -> Set(dishes)
    const map = new Map();

    for (const dish of dishes){
      const items = recipesMap[dish] || [];
      for (const ing of items){
        const key = String(ing).trim();
        if (!key) continue;
        if (!map.has(key)) map.set(key, new Set());
        map.get(key).add(dish);
      }
    }

    // 表示順：食材名の昇順
    const ingredientNames = Array.from(map.keys()).sort((a,b)=> a.localeCompare(b,'ja'));

    needList.innerHTML = ingredientNames.map(ing => {
      const from = Array.from(map.get(ing)).sort((a,b)=> a.localeCompare(b,'ja'));
      // 由来料理を meta として薄く表示（UIは chip のまま）
      return `
        <li class="chip">
          ${escapeHtml(ing)}
          <span class="meta">（${escapeHtml(from.join("、"))}）</span>
        </li>
      `;
    }).join("");
  }

  // ===== XSS対策 =====
  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, c => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[c]));
  }

  function escapeHtmlAttr(s){
    return String(s)
      .replace(/&/g,'&amp;')
      .replace(/"/g,'&quot;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;');
  }

  function unescapeHtmlAttr(s){
    return String(s)
      .replace(/&quot;/g,'"')
      .replace(/&gt;/g,'>')
      .replace(/&lt;/g,'<')
      .replace(/&amp;/g,'&');
  }
</script>

</body>
</html>
